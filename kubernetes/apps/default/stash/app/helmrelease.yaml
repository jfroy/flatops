---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/refs/heads/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: stash
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  driftDetection:
    mode: enabled
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      stash:
        annotations:
          reloader.stakater.com/auto: "true"
        containers:
          sais:
            image:
              repository: ghcr.io/skier233/stash-ai-server
              tag: 0.9.1
            env:
              AI_SERVER_DATA_DIR: /app/data
              AI_SERVER_HOST: 0.0.0.0
              AI_SERVER_PORT: &saisPort 4153
              AI_SERVER_PLUGINS_DIR: /app/plugins
              STASH_DB_PATH: /stash/stash-go.sqlite
              STASH_URL: http://localhost:9999 # NOTE: if the service url is used, stashapi gets EPERM on connect; netpols?
              TZ: America/Los_Angeles
            envFrom:
              - secretRef:
                  name: sais
              - secretRef:
                  name: sais-db
            ports:
              - containerPort: *saisPort
                name: http
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  exec:
                    command:
                      - /bin/sh
                      - -ec
                      - |
                        python3 - <<'PY'
                        import json, sys, urllib.request
                        data = urllib.request.urlopen("http://127.0.0.1:4153/api/v1/system/health", timeout=1).read()
                        j = json.loads(data)
                        sys.exit(0 if j.get("status") == "ok" else 1)
                        PY
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            restartPolicy: Always
          stash:
            image:
              repository: ghcr.io/jfroy/stash
              tag: v0.29.3-cudajellyfin
            env:
              AI_BACKEND_BASE_URL: https://stash.kantai.xyz/sais
              HOME: /config
              NVIDIA_DRIVER_CAPABILITIES: compute,utility,video
              STASH_BLOBS_PATH: /blobs
              STASH_BLOBS_STORAGE: FILESYSTEM
              STASH_CACHE: /cache
              STASH_CONFIG_FILE: /config/config.yml
              STASH_DATABASE: /config/stash-go.sqlite
              STASH_GENERATED: /generated
              STASH_HW_TEST_TIMEOUT: "2"
              STASH_PLUGINS_PATH: /plugins
              STASH_PORT: &port 9999
              STASH_SCRAPERS_PATH: /scrapers
              TZ: America/Los_Angeles
            probes:
              liveness: &probe
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /healthz
                    port: *port
              readiness: *probe
            securityContext:
              allowPrivilegeEscalation: false
              capabilities: { drop: ["ALL"] }
              readOnlyRootFilesystem: true
            resources:
              limits:
                nvidia.com/gpu: 1
            workingDir: /config
        initContainers:
          install-plugins:
            image:
              repository: ghcr.io/instrumentisto/rsync-ssh
              tag: alpine3.22
            command: ["/usr/bin/rsync", "-a", "/install/", "/plugins/managed/"]
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
          nams:
            image:
              repository: registry.kantai.xyz/nams
              tag: 3.0.0@sha256:1c4fc966666afb7ed952b500b10d3d3215c5b7340a7779dc3ec2e6f496bb28b2
            env:
              TZ: America/Los_Angeles
            probes:
              liveness: &probe
                enabled: false
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: 8000
              readiness: *probe
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities: { drop: ["ALL"] }
            resources:
              limits:
                nvidia.com/gpu: 1
            restartPolicy: Always
          sais-initdb:
            image:
              repository: ghcr.io/home-operations/postgres-init
              tag: 18.1.0@sha256:3c54d39f19fdb82ed5b3f286450e4071133cc6025bd0e25856bc2c522f8fc030
            envFrom:
              - secretRef:
                  name: sais-db
              - secretRef:
                  name: sais-initdb
        pod:
          hostname: stash
          nodeSelector:
            nvidia.com/gpu.present: "true"
          runtimeClassName: nvidia
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
            fsGroupChangePolicy: OnRootMismatch
            supplementalGroups: [4000]
    configMaps:
      dockerenv:
        data:
          dockerenv: ""
      sais-initdb:
        data:
          sais.sql: |
            CREATE EXTENSION IF NOT EXISTS "vector";
    persistence:
      cache:
        type: emptyDir
        advancedMounts:
          stash:
            stash:
              - path: /cache
      config:
        existingClaim: ${APP}
        advancedMounts:
          stash:
            sais:
              - path: /stash
                readOnly: true
            stash:
              - path: /config
      data:
        type: persistentVolumeClaim
        storageClass: ceph-block
        accessMode: ReadWriteOnce
        retain: true
        size: 1Ti
        advancedMounts:
          stash:
            stash:
              - path: /blobs
                subPath: blobs
              - path: /generated
                subPath: generated
      dockerenv:
        type: configMap
        identifier: dockerenv
        globalMounts:
          - path: /.dockerenv
            subPath: dockerenv
      nams-license:
        type: secret
        name: nams-license
        advancedMounts:
          stash:
            nams:
              - path: /app/models/.ai_license_fingerprint
                subPath: .ai_license_fingerprint
              - path: /app/models/licenseV1.0.lic
                subPath: licenseV1.0.lic
      nams-logs:
        type: emptyDir
        sizeLimit: 100Mi
        advancedMounts:
          stash:
            nams:
              - path: /app/logs
      plugins:
        type: persistentVolumeClaim
        storageClass: openebs-hostpath
        accessMode: ReadWriteOnce
        retain: true
        size: 100Mi
        advancedMounts:
          stash:
            install-plugins:
              - path: /plugins
            stash:
              - path: /plugins
      sais-data:
        type: persistentVolumeClaim
        storageClass: ceph-block
        accessMode: ReadWriteOnce
        retain: true
        size: 1Gi
        advancedMounts:
          stash:
            sais:
              - path: /app/data
                subPath: data
              - path: /app/plugins
                subPath: plugins
      sais-initdb:
        type: configMap
        identifier: sais-initdb
        advancedMounts:
          stash:
            sais-initdb:
              - path: /initdb
      sais-plugin:
        type: image
        image: registry.kantai.xyz/sais-frontend:0.5.0b2@sha256:eac1c7c1aee019231211b03824eabc824fe6808e9c5009c78b84279d604ae6b6
        advancedMounts:
          stash:
            install-plugins:
              - path: /install/AIOverhaul
      scrapers:
        type: persistentVolumeClaim
        storageClass: openebs-hostpath
        accessMode: ReadWriteOnce
        retain: true
        size: 100Mi
        advancedMounts:
          stash:
            stash:
              - path: /scrapers
      sss:
        type: persistentVolumeClaim
        existingClaim: media-smb-kantai3
        globalMounts:
          - path: /mnt/citerne/media
      tmp:
        type: emptyDir
        medium: Memory
        sizeLimit: 100Mi
    route:
      stash:
        hostnames:
          - "${APP_SUBDOMAIN:-${APP}}.kantai.xyz"
        parentRefs:
          - name: envoy-internal
            namespace: network
        rules:
          - backendRefs:
              - port: *saisPort
                identifier: sais
            filters:
              - type: URLRewrite
                urlRewrite:
                  path:
                    type: ReplacePrefixMatch
                    replacePrefixMatch: /
            matches:
              - path:
                  type: PathPrefix
                  value: /sais
          - backendRefs:
              - port: *port
                identifier: stash
    service:
      sais:
        controller: stash
        ports:
          http:
            port: *saisPort
      stash:
        controller: stash
        forceRename: "{{ .Release.Name }}"
        ports:
          http:
            port: *port
