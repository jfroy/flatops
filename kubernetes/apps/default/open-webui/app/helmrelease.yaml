---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/refs/heads/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: open-webui
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  driftDetection:
    mode: enabled
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      open-webui:
        annotations:
          reloader.stakater.com/auto: "true"
        initContainers:
          init-db:
            image:
              repository: ghcr.io/home-operations/postgres-init
              tag: 17.6.0@sha256:86a1992d46273c58fd4ad95b626081dfaabfe16bd56944675169e406d1a660dd
            envFrom:
              - secretRef:
                  name: open-webui-db
              - secretRef:
                  name: open-webui-initdb
          valkey:
            image:
              repository: ghcr.io/valkey-io/valkey
              tag: 9.0.0@sha256:4503e204c900a00ad393bec83c8c7c4c76b0529cd629e23b34b52011aefd1d27
            args:
              - --save
              - ""
              - --port
              - "6379"
            restartPolicy: Always
        containers:
          open-webui:
            image:
              repository: ghcr.io/open-webui/open-webui
              tag: v0.6.34-cuda
            env:
              #ENABLE_PERSISTENT_CONFIG: False
              CORS_ALLOW_ORIGIN: "https://kantai.xyz"
              DATABASE_TYPE: postgresql
              DATABASE_URL: ""
              ENABLE_FORWARD_USER_INFO_HEADERS: True
              ENABLE_LOGIN_FORM: False
              ENABLE_OAUTH_GROUP_CREATION: True
              ENABLE_OAUTH_GROUP_MANAGEMENT: True
              ENABLE_OAUTH_ID_TOKEN_COOKIE: False
              ENABLE_OAUTH_PERSISTENT_CONFIG: False
              ENABLE_OAUTH_ROLE_MANAGEMENT: True
              ENABLE_OAUTH_SIGNUP: True
              ENABLE_OLLAMA_API: True
              ENABLE_OPENAI_API: True
              ENABLE_OTEL_METRICS: True
              ENABLE_OTEL: False
              ENABLE_SIGNUP: False
              ENABLE_VERSION_UPDATE_CHECK: False
              MODELS_CACHE_TTL: 300
              OAUTH_CODE_CHALLENGE_METHOD: S256
              OAUTH_GROUP_CLAIM: open_webui_groups
              OAUTH_MERGE_ACCOUNTS_BY_EMAIL: True
              OAUTH_PROVIDER_NAME: Pocket ID
              OAUTH_ROLES_CLAIM: open_webui_roles
              OAUTH_UPDATE_PICTURE_ON_LOGIN: True
              OLLAMA_BASE_URL: http://ollama.default.svc.cluster.local:11434
              OPENID_PROVIDER_URL: https://pid.kantai.xyz/.well-known/openid-configuration
              OTEL_EXPORTER_OTLP_ENDPOINT: http://vmagent-kantai.observability.svc.cluster.local:8429/opentelemetry/v1/metrics
              OTEL_EXPORTER_OTLP_INSECURE: True
              REDIS_URL: redis://localhost:6379/0
              THREAD_POOL_SIZE: 10
              TZ: America/Los_Angeles
              WEBSOCKET_REDIS_URL: redis://localhost:6379/1
              WEBUI_AUTH_COOKIE_SECURE: True
              WEBUI_SESSION_COOKIE_SECURE: True
              WEBUI_URL: https://owui.kantai.xyz
            envFrom:
              - secretRef:
                  name: open-webui
              - secretRef:
                  name: open-webui-db
              - secretRef:
                  name: open-webui-keys
            ports:
              - containerPort: 8080
                name: http
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /health
                    port: http
              readiness: *probes
              startup:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /health
                    port: http
                  failureThreshold: 60
            resources:
              limits:
                nvidia.com/gpu: 1
            securityContext:
              allowPrivilegeEscalation: false
              capabilities: { drop: ["ALL"] }
              readOnlyRootFilesystem: true
        pod:
          nodeSelector:
            nvidia.com/gpu.present: "true"
          runtimeClassName: nvidia
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
            fsGroupChangePolicy: OnRootMismatch
    service:
      open-webui:
        ports:
          http:
            port: 8080
    route:
      open-webui:
        hostnames: ["owui.kantai.xyz"]
        parentRefs:
          - name: envoy-internal
            namespace: network
    persistence:
      data:
        existingClaim: "${APP}"
        globalMounts:
          - path: /app/backend/data
      run:
        type: emptyDir
        medium: Memory
        sizeLimit: 128Mi
      tmp:
        type: emptyDir
        medium: Memory
        sizeLimit: 128Mi
