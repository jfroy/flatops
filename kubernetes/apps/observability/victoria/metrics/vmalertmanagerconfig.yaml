---
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMAlertmanagerConfig
metadata:
  name: kantai
spec:
  route:
    receiver: "blackhole"
    group_by: ["alertname", "job"]
    routes:
      - receiver: "blackhole"
        matchers: [alertname=InfoInhibitor]
      - receiver: heartbeat
        group_interval: 5m
        group_wait: 0s
        repeat_interval: 5m
        matchers: [alertname=Watchdog]
      - receiver: discord
        group_interval: 10m
        group_wait: 1m
        repeat_interval: 1h
        matchers: [severity=~critical|error|warning]
  receivers:
  - name: "blackhole"
  - name: heartbeat
    webhook_configs:
      - url_secret:
          name: alertmanager-secrets
          key: healthchecks-io-url
  - name: discord
    discord_configs:
      - send_resolved: true
        webhook_url_secret:
          name: alertmanager-secrets
          key: discord-webhook-url
        title: >-
          {{ .GroupLabels.alertname }} - {{ .GroupLabels.namespace }}
          {{- if ne .CommonLabels.severity "" }} ({{ .CommonLabels.severity}}){{- end }}
          ({{ .GroupLabels.cluster }})
          [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}]
        message: |-
          {{- $root := . -}}
          {{- $rm := stringSlice "instance" "kubernetes_node" "endpoint" "prometheus" "service" "cluster" "container" "job" "severity" -}}
          {{- $common := ( ( .CommonLabels.Remove $root.GroupLabels.Names ).Remove $rm ) -}}
          {{- if gt (len $common.SortedPairs) 0 -}}
          ## Common Labels
          {{- range $common.SortedPairs }}
          > {{ .Name }}: `{{ .Value }}`
          {{- end }}
          {{- end }}
          ## Alerts
          {{- range .Alerts }}
            {{- $msg := "Alert description not available" }}
            {{- if ne .Annotations.description "" }}
            {{- $msg = .Annotations.description }}
            {{- else if ne .Annotations.summary "" }}
            {{- $msg = .Annotations.summary }}
            {{- else if ne .Annotations.message "" }}
            {{- $msg = .Annotations.message }}
            {{- end }}
          - {{ reReplaceAll "([^\n])\n([^\n])" "$1 $2" $msg | reReplaceAll "\n" "\n  " | trimSpace }}
            {{- "\n  " }}
            > [Source]({{ .GeneratorURL }})
            > [Runbook]({{ .Annotations.runbook_url }})
            {{- $uniq := ( ( .Labels.Remove $root.GroupLabels.Names ).Remove $root.CommonLabels.Names ) }}
            {{- if gt (len $uniq.SortedPairs) 0 }}
              {{- range $uniq.SortedPairs }}
            > {{ .Name }}: `{{ .Value }}`
              {{- end }}
            {{- end }}
          {{- end }}
  inhibit_rules:
    - source_matchers: [severity=critical]
      target_matchers: [severity=~error|warning|info]
      equal: ["namespace", "alertname"]
    - source_matchers: [severity=~error|warning]
      target_matchers: [severity=info]
      equal: ["namespace", "alertname"]
    - source_matchers: [alertname=InfoInhibitor]
      target_matchers: [severity=info]
      equal: ["namespace"]
    - target_matchers: [alertname=InfoInhibitor]
