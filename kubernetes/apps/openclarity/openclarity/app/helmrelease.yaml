---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app openclarity
spec:
  interval: 30m
  chartRef:
    kind: OCIRepository
    name: openclarity
    namespace: flux-system
  driftDetection:
    mode: enabled
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    apiserver:
      database:
        postgresql:
          enabled: false
        # externalPostgresql:
        #   enabled: true
        #   host: postgres16-rw.database.svc.cluster.local
        #   port: "5432"
        #   auth:
        #     existingSecret: db-secret
        sqlite:
          enabled: true
    orchestrator:
      serviceAccount:
        automountServiceAccountToken: true
      provider: kubernetes
  postRenderers:
    - kustomize:
        patches:
          - patch: |-
              apiVersion: apps/v1
              kind: DaemonSet
              metadata:
                name: openclarity-cr-discovery-server
              spec:
                template:
                  metadata:
                    labels:
                      allow-host-paths: "true"
          - target:
              group: apps
              version: v1
              kind: DaemonSet
              name: openclarity-cr-discovery-server
            patch: |
              - op: remove
                path: /spec/template/spec/volumes
              - op: remove
                path: /spec/template/spec/containers/0/volumeMounts
                value: Directory
              - op: add
                path: /spec/template/spec/volumes
                value: []
              - op: add
                path: /spec/template/spec/volumes/-
                value: {"name": "containerd", "hostPath": {"path": "/run/containerd", "type": "Directory"}}
              - op: add
                path: /spec/template/spec/containers/0/volumeMounts
                value: []
              - op: add
                path: /spec/template/spec/containers/0/volumeMounts/-
                value: {"mountPath": "/run/containerd", "name": "containerd", "readOnly": true}
