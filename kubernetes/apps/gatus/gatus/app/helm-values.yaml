# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-3.0.1/charts/other/app-template/values.schema.json
controllers:
  gatus:
    containers:
      app:
        image:
          repository: ghcr.io/twin/gatus
          tag: v5.8.0@sha256:fecb4c38722df59f5e00ab4fcf2393d9b8dad9161db208d8d79386dc86da8a55
        env:
          TZ: America/Los_Angeles
          GATUS_CONFIG_PATH: /config
          WEB_PORT: &port 80
          POSTGRES_URI:
            valueFrom:
              secretKeyRef:
                name: cnpg-cluster-app
                key: uri
        probes:
          liveness: &probes
            enabled: true
            custom: true
            spec:
              httpGet:
                path: &path /health
                port: *port
              initialDelaySeconds: 0
              periodSeconds: 10
              timeoutSeconds: 1
              failureThreshold: 3
          readiness: *probes
        securityContext: &securityContext
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities: { drop: ["ALL"] }
        resources: &resources
          requests:
            cpu: 10m
          limits:
            memory: 128Mi
    initContainers:
      config-sync:
        image:
          repository: ghcr.io/kiwigrid/k8s-sidecar
          tag: 1.26.1@sha256:b8d5067137fec093cf48670dc3a1dbb38f9e734f3a6683015c2e89a45db5fd16
        env:
          FOLDER: /config
          LABEL: gatus.io/enabled
          NAMESPACE: ALL
          RESOURCE: configmap
          UNIQUE_FILENAMES: true
        securityContext: *securityContext
        resources: *resources
        restartPolicy: Always
    pod:
      dnsConfig:
        options:
          - { name: ndots, value: "1" }
      securityContext:
        runAsUser: 568
        runAsGroup: 568
        runAsNonRoot: true
        fsGroup: 568
        fsGroupChangePolicy: OnRootMismatch
service:
  app:
    controller: gatus
    ports:
      http:
        port: *port
serviceMonitor:
  app:
    serviceName: gatus
    endpoints:
      - port: http
        scheme: http
        path: /metrics
        interval: 1m
        scrapeTimeout: 10s
serviceAccount:
  create: true
  name: gatus
persistence:
  config:
    type: emptyDir
  config-file:
    type: configMap
    name: gatus-config
    globalMounts:
      - path: /config/config.yaml
        subPath: config.yaml
        readOnly: true
