---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/source.toolkit.fluxcd.io/ocirepository_v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: OCIRepository
metadata:
  name: fluent-bit
spec:
  interval: 15m
  layerSelector:
    mediaType: application/vnd.cncf.helm.chart.content.v1.tar+gzip
    operation: copy
  ref:
    tag: 0.54.0
  url: oci://ghcr.io/home-operations/charts-mirror/fluent-bit
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: fluent-bit
spec:
  chartRef:
    kind: OCIRepository
    name: fluent-bit
  interval: 1h
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    config:
      service: |-
        [SERVICE]
          daemon off
          flush {{ .Values.flush }}
          log_level {{ .Values.logLevel }}
          parsers_file /fluent-bit/etc/parsers.conf
          parsers_file /fluent-bit/etc/conf/custom_parsers.conf
          http_server on
          http_listen 0.0.0.0
          http_port {{ .Values.metricsPort }}
          health_check on
          storage.path /var/fluent-bit
          storage.sync normal
          storage.checksum off
          storage.backlog.mem_limit 5M

      inputs: |-
        [INPUT]
          name tail
          alias kubernetes
          path /var/log/containers/*.log
          parser containerd
          tag kubernetes.*
          skip_empty_lines on
          skip_long_lines on
          storage.type filesystem

      filters: |-
        [FILTER]
          name kubernetes
          match kubernetes.*
          merge_log on
          kube_tag_prefix kubernetes.var.log.containers.
          k8s-logging.parser on
          k8s-logging.exclude on
          namespace_labels off
          annotations off
          buffer_size 64k

        [FILTER]
          name nest
          match kubernetes.*
          operation lift
          nested_under kubernetes
          add_prefix k8s_

        [FILTER]
          name nest
          match kubernetes.*
          operation lift
          nested_under k8s_labels
          add_prefix k8s_labels_

        [FILTER]
          name modify
          match kubernetes.*
          rename k8s_labels_app.kubernetes.io/name app
          rename k8s_labels_app app
          rename k8s_labels_k8s-app app
          rename k8s_namespace_name namespace
          rename k8s_pod_name pod
          rename k8s_container_name container
          rename k8s_host node
          remove_wildcard k8s_*
          remove_regex ^k8s_.*

      customParsers: |-
        [PARSER]
          name containerd
          format regex
          regex ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$
          time_key time
          time_format %Y-%m-%dT%H:%M:%S.%L%z

      outputs: |-
        [OUTPUT]
          name http
          match kubernetes.*
          host vlsingle-kantai.observability.svc.cluster.local
          port 9428
          uri /insert/jsonline?_stream_fields=stream,namespace,pod,container,app,node&_msg_field=log&_time_field=date
          format json_lines
          json_date_format iso8601
          compress gzip
          log_response_payload false
          retry_limit false
          storage.total_limit_size 1G
    daemonSetVolumes:
      - name: etcmachineid
        hostPath:
          path: /etc/machine-id
          type: File
      - name: varflb
        hostPath:
          path: /var/fluent-bit
          type: DirectoryOrCreate
      - name: varlog
        hostPath:
          path: /var/log
    daemonSetVolumeMounts:
      - name: etcmachineid
        mountPath: /etc/machine-id
        readOnly: true
      - name: varflb
        mountPath: /var/fluent-bit
      - name: varlog
        mountPath: /var/log
    dashboards:
      enabled: true
    image:
      repository: ghcr.io/fluent/fluent-bit
    logLevel: warn
    serviceMonitor:
      enabled: true
    tolerations:
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
