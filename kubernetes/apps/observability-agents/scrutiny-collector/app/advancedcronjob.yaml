---
apiVersion: apps.kruise.io/v1alpha1
kind: AdvancedCronJob
metadata:
  name: scrutiny-collector
  annotations:
    kustomize.toolkit.fluxcd.io/force: enabled
spec:
  schedule: "30 * * * *" # every hour on the half hour
  template:
    broadcastJobTemplate:
      spec:
        template:
          spec:
            containers:
              - name: collector
                image: ghcr.io/analogj/scrutiny:v0.8.1-collector@sha256:5f6536d68be2d7424627647cdd658e6b4c1f69751a21622fb97b999a3155ba86
                imagePullPolicy: IfNotPresent
                command:
                  - /opt/scrutiny/bin/scrutiny-collector-metrics
                  - run
                env:
                  - name: COLLECTOR_API_ENDPOINT
                    value: http://scrutiny.observability.svc.cluster.local:8080
                  - name: COLLECTOR_HOST_ID
                    valueFrom:
                      fieldRef:
                        fieldPath: spec.nodeName
                securityContext:
                  privileged: true
                  readOnlyRootFilesystem: true
                  runAsUser: 0
                volumeMounts:
                  - mountPath: /opt/scrutiny/config
                    name: config
                  - mountPath: /run/udev
                    name: udev
                    readOnly: true
                  - mountPath: /dev
                    name: dev
                    readOnly: true
            restartPolicy: Never
            volumes:
              - name: config
                emptyDir:
                  sizeLimit: 10Mi
              - name: udev
                hostPath:
                  path: /run/udev
              - name: dev
                hostPath:
                  path: /dev
