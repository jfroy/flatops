---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: media-smb
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: media-smb
    template:
      data:
        users.json: |-
          {
            "samba-container-config": "v0",
            "users": {
              {{- $users := list }}
              {{- $users = append $users (dict "name" .username "password" .password "uid" (.uid | atoi) "gid" (.gid | atoi)) }}
              "all_entries": {{ $users | toJson }}
            }
          }
  dataFrom:
    - extract:
        key: media-smb
