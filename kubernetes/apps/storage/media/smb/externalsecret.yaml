---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: media-smb
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: media-smb-secret
    template:
      engineVersion: v2
      data:
        users: |-
          {
            "samba-container-config": "v0",
            "users": {
              {{- $users := list }}
              {{- range $u, $p := . }}
                {{- if $p }}
                  {{- $users = append $users (dict "name" $u "password" $p) }}
                {{- end }}
              {{- end }}
              "all_entries": {{ $users | toJson }}
            }
          }
  dataFrom:
    - extract:
        key: media-smb
